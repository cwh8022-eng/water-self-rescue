<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ°´ä¸Šè‡ªæ•‘é—–é—œä»»å‹™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --ink: #263159;
      --primary: #FF8F52;
      --headline: #495579;
      --paper: #FFFDF7;
      --success: #16a34a;
      --danger: #ef4444;
      --accent: #8b5cf6;
    }
    body { background: var(--paper); color: var(--ink); }
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.08); }

    /* å®Œæˆå°ç«  */
    .stamp-wrap { position: relative; }
    .stamp-svg {
      position:absolute; top:-10px; left:50%; transform:translateX(-50%) rotate(-8deg) scale(0.2);
      width:120px; height:120px; opacity:0; pointer-events:none;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
    }
    .stamp-bounce { animation: stampIn .7s ease-out forwards; }
    @keyframes stampIn {
      0% { transform:translateX(-50%) rotate(-8deg) scale(0.2); opacity:0; }
      60% { transform:translateX(-50%) rotate(-6deg) scale(1.15); opacity:1; }
      100% { transform:translateX(-50%) rotate(-8deg) scale(1); opacity:1; }
    }

    /* Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.show { display:flex; }
    .modal-card { width: min(460px, 92vw); background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #eee; }
    .close-x { font-size:20px; font-weight:700; cursor:pointer; }
    .modal-body { padding:1rem; }

    /* æŒ‰éˆ•/å¾½ç«  */
    .btn { padding:.6rem 1rem; border-radius:.75rem; font-weight:700; }
    .btn-green { background:var(--success); color:#fff; }
    .btn-purple { background:var(--accent); color:#fff; }
    .btn-red { background:var(--danger); color:#fff; }
    .btn-ghost { background:#f3f4f6; }
    .badge { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; border-radius:999px; font-weight:700; }
    .badge-silver { background:#eef2ff; border:2px solid #c7d2fe; }
    .badge-gold { background:#fff7e6; border:2px solid #facc15; }
    .badge-trophy { background:#fff1f2; border:2px solid #fb7185; }

    /* çç›ƒå‹•ç•« */
    .trophy-wrap { position:fixed; left:50%; top:-40vh; transform:translateX(-50%); z-index:60; pointer-events:none; display:none; }
    .trophy-wrap.show { display:block; animation: dropIn 1s ease-out forwards, glow 2s ease-in-out 1s infinite alternate; }
    @keyframes dropIn { 0% { top:-40vh; } 80% { top:15vh; } 100% { top:18vh; } }
    @keyframes glow { from { filter: drop-shadow(0 0 0 rgba(250, 204, 21, .8)); } to { filter: drop-shadow(0 0 18px rgba(250, 204, 21, 1)); } }
  </style>
</head>
<body class="min-h-screen">
  <!-- çç›ƒ -->
  <div id="trophy" class="trophy-wrap" aria-hidden="true">
    <svg width="220" height="220" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#facc15"/><stop offset="100%" stop-color="#eab308"/></linearGradient></defs>
      <g fill="url(#g)" stroke="#92400e" stroke-width="1">
        <path d="M12 8h40v6a14 14 0 0 1-14 14H26A14 14 0 0 1 12 14z"/>
        <path d="M16 8v-4h32v4z"/>
        <rect x="28" y="28" width="8" height="8" rx="1"/>
        <rect x="24" y="36" width="16" height="6" rx="1"/>
        <rect x="20" y="42" width="24" height="6" rx="1"/>
        <rect x="16" y="48" width="32" height="6" rx="1"/>
      </g>
      <circle cx="32" cy="19" r="7" fill="#fde68a" opacity=".7"/>
    </svg>
  </div>

  <!-- é é¦– -->
  <header class="text-center px-4 py-6">
    <h1 class="text-3xl md:text-4xl font-extrabold text-[var(--headline)]">æ°´ä¸Šè‡ªæ•‘é—–é—œä»»å‹™</h1>
  </header>

  <!-- ç™»å…¥å€ -->
  <section id="loginSection" class="max-w-xl card mx-auto p-6 my-6">
    <h2 class="text-xl font-bold">å­¸ç”Ÿç™»å…¥</h2>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <input id="studentId" class="border rounded-lg p-3" placeholder="å­¸è™Ÿ" />
      <input id="studentName" class="border rounded-lg p-3" placeholder="å§“å" />
    </div>
    <div class="mt-4 flex gap-3">
      <button class="btn btn-green" onclick="login()">ç™»å…¥</button>
    </div>
  </section>

  <!-- ä¸»å…§å®¹ -->
  <main id="app" class="container mx-auto px-4 pb-20 hidden">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        <span id="helloText" class="font-bold"></span>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-red" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- é€²åº¦ç¸½è¦½ -->
    <section class="card p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
        <div class="justify-self-center">
          <canvas id="overallChart" width="220" height="220"></canvas>
        </div>
        <div class="md:col-span-2">
          <h3 class="text-xl font-bold mb-2">å€‹äººé€²åº¦</h3>
          <p id="overallText" class="text-sm text-gray-700 mb-3">å·²å®Œæˆ 0/4 (0%)</p>
          <div class="flex flex-wrap gap-2 items-center">
            <span id="badge3" class="badge badge-silver hidden">ğŸ¥ˆ éŠ€ç‰Œï¼ˆ3/4ï¼‰</span>
            <span id="badge4" class="badge badge-gold hidden">ğŸ¥‡ é‡‘ç‰Œï¼ˆå…¨éƒ¨å®Œæˆï¼‰</span>
          </div>
        </div>
      </div>
    </section>

    <!-- é—œå¡å¡ç‰‡ -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
      <div id="cards" class="contents"></div>
    </section>
  </main>

  <!-- Glossary Modal -->
  <div id="glossaryModal" class="modal" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="glossaryTitle">èªªæ˜è¡“èª</h3>
        <span class="close-x" onclick="closeGlossary()">âœ–</span>
      </div>
      <div class="modal-body p-4">
        <p id="glossaryBody" class="text-gray-800 leading-7"></p>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="videoTitle">å­¸ç¿’è³‡æº</h3>
        <span class="close-x" onclick="closeVideo()">âœ–</span>
      </div>
      <div class="modal-body">
        <div class="aspect-video w-full">
          <iframe id="videoFrame" class="w-full h-[60vh]" src="" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="passwordTitle">è¼¸å…¥å¯†ç¢¼</h3>
        <span class="close-x" onclick="closePassword()">âœ–</span>
      </div>
      <div class="modal-body">
        <p class="mb-3 text-gray-700" id="passwordDesc"></p>
        <input id="passwordInput" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
               class="border rounded-lg p-2 w-full mb-3" />
        <button class="btn btn-green w-full" id="passwordBtn">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script>
    const TOTAL = 4;
    const PASSWORD = "888";
    let currentStudent = null;
    let currentChallenge = null;

    const GLOSSARY = {
      'æ°´æ¯æ¼‚': 'é›™æ‰‹é›™è…³è‡ªç„¶å¼µé–‹ï¼Œè‡‰æœä¸‹æ”¾é¬†ï¼Œé›™æ‰‹é›™è…³è‡ªç„¶æ”¾é¬†æ¼‚æµ®æ–¼æ°´é¢ã€‚',
      'ä»°æ¼‚': 'è‡‰æœä¸Šï¼Œè€³æœµæµ¸å…¥æ°´ä¸­ï¼Œæ‰‹è…³å¼µé–‹æ”¾é¬†ï¼Œä¿æŒå‘¼å¸å¹³ç©©æ¼‚æµ®ã€‚',
      'è¸©æ°´': 'é›™è…¿äº¤æ›¿æ‰“æ°´æˆ–ç•«åœˆï¼Œä¿æŒé ­éƒ¨åœ¨æ°´é¢ä¸Šã€‚',
      'æ‹‹ç¹©': 'ä½¿ç”¨æ‹‹ç¹©æ‹‹å‘æŒ‡å®šä½ç½®ã€‚'
    };

    const CHALLENGES = [
      {title:'æ°´æ¯æ¼‚', goal:'å­¸æœƒè‡‰æœä¸‹æ”¾é¬†æ¼‚æµ®ã€‚', method:'åœ¨æ°´ä¸­é›™æ‰‹é›™è…³è‡ªç„¶æ”¾é¬†ï¼Œç¶­æŒè‡³å°‘ 1 åˆ†é˜ã€‚', video:''},
      {title:'ä»°æ¼‚', goal:'å­¸æœƒè‡‰æœä¸Šæ¼‚æµ®ã€‚', method:'è€³æœµå…¥æ°´ï¼Œé›™æ‰‹é›™è…³å¼µé–‹ï¼Œç¶­æŒè‡³å°‘ 1 åˆ†é˜ã€‚', video:''},
      {title:'è¸©æ°´', goal:'å­¸æœƒä¿æŒé ­éƒ¨åœ¨æ°´é¢ä¸Šã€‚', method:'é€£çºŒè¸©æ°´ 1 åˆ†é˜ä¸æ²‰ä¸‹å»ã€‚', video:''},
      {title:'æ‹‹ç¹©', goal:'å­¸æœƒæ­£ç¢ºæ‹‹ç¹©æ•‘æ´ã€‚', method:'å°‡ç¹©å­æº–ç¢ºæ‹‹å‘æŒ‡å®šç›®æ¨™ã€‚', video:''}
    ];

    const qs = (sel) => document.querySelector(sel);
    const nowISO = () => new Date().toISOString();
    function keyFor(student) { return `water_${student}`; }
    function getProgress(student) { return JSON.parse(localStorage.getItem(keyFor(student)) || '{}'); }
    function setProgress(student, obj) { localStorage.setItem(keyFor(student), JSON.stringify(obj)); }
    function beep() { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='triangle'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime + 0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.32); o.start(); o.stop(ctx.currentTime + 0.33); }

    function login() {
      const id = qs('#studentId').value.trim();
      const name = qs('#studentName').value.trim();
      if(!id || !name) return alert('è«‹è¼¸å…¥å­¸è™Ÿèˆ‡å§“å');
      currentStudent = `${id}_${name}`;
      const p = getProgress(currentStudent);
      if(!p._meta) p._meta = { createdAt: nowISO(), lastUpdatedAt: nowISO(), wrongPassword: {}, firstFinishAt: null };
      setProgress(currentStudent, p);
      qs('#helloText').textContent = `Hiï¼Œ${name}`;
      qs('#loginSection').classList.add('hidden');
      qs('#app').classList.remove('hidden');
      renderCards(); loadStamps(); updateOverall();
    }
    function logout(){ currentStudent=null; qs('#app').classList.add('hidden'); qs('#loginSection').classList.remove('hidden'); }

    function cardTemplate(idx, c){
      return `
      <article class="card p-5 stamp-wrap relative">
        <svg id="stamp${idx}" class="stamp-svg" viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="46" fill="none" stroke="#ef4444" stroke-width="6"></circle>
          <text x="60" y="66" text-anchor="middle" font-size="22" font-weight="800" fill="#ef4444">å®Œæˆ</text>
        </svg>
        <h3 class="text-xl font-bold mb-2">é—œå¡${idx}ï¼š${c.title}</h3>
        <p class="text-sm text-gray-700"><b>ç›®æ¨™ï¼š</b>${c.goal}</p>
        <p class="text-sm text-gray-700 mt-1"><b>åŸ·è¡Œæ–¹å¼ï¼š</b>${c.method}</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="btn btn-ghost" onclick="openGlossary('${c.title}')">âœ¨ èªªæ˜è¡“èª</button>
          <button class="btn btn-purple" onclick="openVideo(${idx}, '${c.title}', '${c.video}')">ğŸ“˜ å­¸ç¿’è³‡æº</button>
          <button class="btn btn-green" onclick="verify(${idx}, '${c.title}')">âœ… é—–é—œæˆåŠŸ</button>
        </div>
      </article>`;
    }
    function renderCards(){ qs('#cards').innerHTML = CHALLENGES.map((c,i)=>cardTemplate(i+1,c)).join(''); }

    function loadStamps(){ const p=getProgress(currentStudent); for(let i=1;i<=TOTAL;i++){ if(p['challenge'+i]===true) qs('#stamp'+i)?.classList.add('stamp-bounce'); } }
    function markDone(i){ const el=qs('#stamp'+i); if(!el) return; el.classList.remove('stamp-bounce'); void el.offsetWidth; el.classList.add('stamp-bounce'); }

    function verify(i, title){
      currentChallenge = { i, title };
      qs('#passwordTitle').textContent = `é©—è­‰ï¼šé—œå¡${i} ${title}`;
      qs('#passwordDesc').textContent = `è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªã€Œé—œå¡${i}ï¼š${title}ã€éé—œï¼š`;
      qs('#passwordInput').value = '';
      qs('#passwordModal').classList.add('show');
    }
    function closePassword(){ qs('#passwordModal').classList.remove('show'); }

    document.getElementById('passwordBtn').addEventListener('click', () => {
      const input = document.getElementById('passwordInput').value;
      const { i, title } = currentChallenge;
      const p = getProgress(currentStudent);
      if(!p._meta) p._meta={createdAt:nowISO(),lastUpdatedAt:nowISO(),wrongPassword:{},firstFinishAt:null};

      if(input===PASSWORD){
        p['challenge'+i]=true;
        p._meta.lastUpdatedAt=nowISO();
        const count=countCompleted(p);
        if(count===TOTAL && !p._meta.firstFinishAt) p._meta.firstFinishAt=nowISO();
        setProgress(currentStudent,p);
        markDone(i); beep(); updateOverall();
        alert(`ğŸ‰ æ­å–œï¼é—œå¡${i} å·²é€šéï¼`);
        closePassword();
      } else {
        const wp=p._meta.wrongPassword||{}; wp[i]=(wp[i]||0)+1;
        p._meta.wrongPassword=wp; p._meta.lastUpdatedAt=nowISO(); setProgress(currentStudent,p);
        alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
      }
    });

    let overallChart;
    function countCompleted(p){ return Object.keys(p).filter(k=>k.startsWith('challenge') && p[k]===true).length; }
    function updateOverall(){
      const p=getProgress(currentStudent); const done=countCompleted(p); const percent=Math.round(done/TOTAL*100);
      qs('#overallText').textContent = `å·²å®Œæˆ ${done}/${TOTAL} (${percent}%)`;
      qs('#badge3').classList.toggle('hidden', done<3);
      qs('#badge4').classList.toggle('hidden', done<TOTAL);
      const ctx=document.getElementById('overallChart').getContext('2d');
      if(!overallChart){ overallChart=new Chart(ctx,{ type:'doughnut', data:{ datasets:[{ data:[done, TOTAL-done], borderWidth:4 }]}, options:{ cutout:'75%', plugins:{ legend:{display:false}, tooltip:{enabled:false} } } }); }
      else { overallChart.data.datasets[0].data=[done, TOTAL-done]; overallChart.update(); }
      if(done===TOTAL) showTrophy(); else hideTrophy();
    }
    function showTrophy(){ document.getElementById('trophy').classList.add('show'); beep(); }
    function hideTrophy(){ document.getElementById('trophy').classList.remove('show'); }

    function openGlossary(title){ qs('#glossaryTitle').textContent = `èªªæ˜è¡“èªï¼š${title}`; qs('#glossaryBody').textContent = GLOSSARY[title] || 'ï¼ˆå°šç„¡èªªæ˜ï¼‰'; qs('#glossaryModal').classList.add('show'); }
    function closeGlossary(){ qs('#glossaryModal').classList.remove('show'); }
    function openVideo(i,title,url){ qs('#videoTitle').textContent = `å­¸ç¿’è³‡æºï¼šé—œå¡${i}ã€Œ${title}ã€`; if(url){ const src = url.includes('embed')?url:url.replace('watch?v=','embed/'); qs('#videoFrame').src = src; } qs('#videoModal').classList.add('show'); }
    function closeVideo(){ qs('#videoFrame').src=''; qs('#videoModal').classList.remove('show'); }
  </script>
</body>
</html>
