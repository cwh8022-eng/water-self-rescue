<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è»Ÿå¼ç¶²çƒæŠ€èƒ½é—–é—œä»»å‹™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --ink: #263159;
      --primary: #FF8F52;
      --headline: #495579;
      --paper: #FFFDF7;
      --success: #16a34a;
      --danger: #ef4444;
      --accent: #8b5cf6;
    }
    body { background: var(--paper); color: var(--ink); }
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .stamp-wrap { position: relative; }
    /* ç´…è‰²å®Œæˆå°ç« ï¼ˆSVGï¼‰ */
    .stamp-svg {
      position:absolute; top:-10px; left:50%; transform:translateX(-50%) rotate(-8deg) scale(0.2);
      width:120px; height:120px; opacity:0; pointer-events:none;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
    }
    .stamp-bounce { animation: stampIn .7s ease-out forwards; }
    @keyframes stampIn {
      0% { transform:translateX(-50%) rotate(-8deg) scale(0.2); opacity:0; }
      60% { transform:translateX(-50%) rotate(-6deg) scale(1.15); opacity:1; }
      100% { transform:translateX(-50%) rotate(-8deg) scale(1); opacity:1; }
    }

    /* Modal åŸºç¤ */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.show { display:flex; }
    .modal-card { width: min(960px, 92vw); background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #eee; }
    .close-x { font-size:20px; font-weight:700; cursor:pointer; }
    .modal-body { padding:0; }

    /* é€²åº¦ç¸½è¦½å¾½ç«  */
    .badge { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; border-radius:999px; font-weight:700; }
    .badge-silver { background:#eef2ff; border:2px solid #c7d2fe; }
    .badge-gold { background:#fff7e6; border:2px solid #facc15; }
    .badge-trophy { background:#fff1f2; border:2px solid #fb7185; }

    /* é‡‘è‰²çç›ƒå‹•ç•« */
    .trophy-wrap { position:fixed; left:50%; top:-40vh; transform:translateX(-50%); z-index:60; pointer-events:none; display:none; }
    .trophy-wrap.show { display:block; animation: dropIn 1s ease-out forwards, glow 2s ease-in-out 1s infinite alternate; }
    @keyframes dropIn {
      0% { top:-40vh; }
      80% { top:15vh; }
      100% { top:18vh; }
    }
    @keyframes glow {
      from { filter: drop-shadow(0 0 0 rgba(250, 204, 21, .8)); }
      to   { filter: drop-shadow(0 0 18px rgba(250, 204, 21, 1)); }
    }

    /* æ•™å¸«æ¨¡å¼æç¤º */
    .teacher-badge { background:#ede9fe; color:#5b21b6; border:1px dashed #a78bfa; }

    /* è¡¨æ ¼ */
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; }
    thead tr { background:#f3f4f6; }

    /* å°å·¥å…· */
    .btn { padding:.6rem 1rem; border-radius:.75rem; font-weight:700; }
    .btn-green { background:var(--success); color:#fff; }
    .btn-purple { background:var(--accent); color:#fff; }
    .btn-red { background:var(--danger); color:#fff; }
    .btn-ghost { background:#f3f4f6; }
  </style>
</head>
<body class="min-h-screen">
  <!-- å·¨å¤§é‡‘è‰²çç›ƒ -->
  <div id="trophy" class="trophy-wrap">
    <svg width="220" height="220" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="#facc15"/>
          <stop offset="100%" stop-color="#eab308"/>
        </linearGradient>
      </defs>
      <g fill="url(#g)" stroke="#92400e" stroke-width="1">
        <path d="M12 8h40v6a14 14 0 0 1-14 14H26A14 14 0 0 1 12 14z"/>
        <path d="M16 8v-4h32v4z"/>
        <rect x="28" y="28" width="8" height="8" rx="1"/>
        <rect x="24" y="36" width="16" height="6" rx="1"/>
        <rect x="20" y="42" width="24" height="6" rx="1"/>
        <rect x="16" y="48" width="32" height="6" rx="1"/>
      </g>
      <circle cx="32" cy="19" r="7" fill="#fde68a" opacity=".7"/>
    </svg>
  </div>

  <!-- é é¦– -->
  <header class="text-center px-4 py-6">
    <h1 class="text-3xl md:text-4xl font-extrabold text-[var(--headline)]">è»Ÿå¼ç¶²çƒæŠ€èƒ½é—–é—œä»»å‹™å–®</h1>
    <p class="text-sm text-gray-600 mt-2">ç™»å…¥å¾Œé–‹å§‹é—–é—œ â€” å®Œæˆæ¯ä¸€é—œè¼¸å…¥å¯†ç¢¼ <b>888</b> å–å¾—å®Œæˆå°ç« ï¼</p>
  </header>

  <!-- ç™»å…¥å€ -->
  <section id="loginSection" class="max-w-xl card mx-auto p-6 my-6">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold">å­¸ç”Ÿç™»å…¥</h2>
      <span id="modePill" class="badge teacher-badge hidden">æ•™å¸«æ¨¡å¼</span>
    </div>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <input id="studentId" class="border rounded-lg p-3" placeholder="å­¸è™Ÿ" />
      <input id="studentName" class="border rounded-lg p-3" placeholder="å§“å" />
    </div>
    <div class="mt-4 flex gap-3">
      <button class="btn btn-green" onclick="login()">ç™»å…¥</button>
      <button class="btn btn-ghost" onclick="toggleTeacherMode()">åˆ‡æ›æ•™å¸«æ¨¡å¼</button>
    </div>
    <p class="text-xs text-gray-500 mt-3">æç¤ºï¼šæ•™å¸«æ¨¡å¼å¯æŸ¥çœ‹æ’è¡Œæ¦œèˆ‡ç¸½è¦½ï¼Œç”¨æ–¼èª²å ‚å±•ç¤ºã€‚</p>
  </section>

  <!-- ä¸»å…§å®¹ -->
  <main id="app" class="container mx-auto px-4 pb-20 hidden">
    <!-- æ§åˆ¶åˆ— -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        <span id="helloText" class="font-bold"></span>
        <span id="modePill2" class="badge teacher-badge hidden">æ•™å¸«æ¨¡å¼</span>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-purple" onclick="openLeaderboard()">æ’è¡Œæ¦œ</button>
        <button class="btn btn-red" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- é€²åº¦ç¸½è¦½ -->
    <section class="card p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
        <div class="justify-self-center">
          <canvas id="overallChart" width="220" height="220"></canvas>
        </div>
        <div class="md:col-span-2">
          <h3 class="text-xl font-bold mb-2">å€‹äººé€²åº¦</h3>
          <p id="overallText" class="text-sm text-gray-700 mb-3">å·²å®Œæˆ 0/10 (0%)</p>
          <div class="flex flex-wrap gap-2 items-center">
            <span id="badge5" class="badge badge-silver hidden">ğŸ¥ˆ éŠ€ç‰Œï¼ˆ5/10ï¼‰</span>
            <span id="badge8" class="badge badge-gold hidden">ğŸ¥‡ é‡‘ç‰Œï¼ˆ8/10ï¼‰</span>
            <span id="badge10" class="badge badge-trophy hidden">ğŸ† å…¨éƒ¨å®Œæˆï¼ˆ10/10ï¼‰</span>
          </div>
        </div>
      </div>
    </section>

    <!-- é—œå¡å€ -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- å¡ç‰‡æœƒç”± JS æ³¨å…¥ -->
      <div id="cards" class="contents"></div>
    </section>
  </main>

  <!-- èªªæ˜è¡“èª Modal -->
  <div id="glossaryModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="glossaryTitle">èªªæ˜è¡“èª</h3>
        <span class="close-x" onclick="closeGlossary()">âœ–</span>
      </div>
      <div class="modal-body p-4">
        <p id="glossaryBody" class="text-gray-800 leading-7"></p>
      </div>
    </div>
  </div>

  <!-- å½±ç‰‡ Modal -->
  <div id="videoModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="videoTitle">å­¸ç¿’è³‡æº</h3>
        <span class="close-x" onclick="closeVideo()">âœ–</span>
      </div>
      <div class="modal-body">
        <div class="aspect-video w-full">
          <iframe id="videoFrame" class="w-full h-[60vh]" src="" title="YouTube video" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œ Modal -->
  <div id="leaderboardModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold">æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</h3>
        <span class="close-x" onclick="closeLeaderboard()">âœ–</span>
      </div>
      <div class="modal-body p-4">
        <table>
          <thead>
            <tr>
              <th>å­¸è™Ÿ</th><th>å§“å</th><th>å®Œæˆé—œå¡</th><th>å®Œæˆç‡</th><th>æœ€å¾Œæ›´æ–°</th><th>é€šé—œç¸½æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
        <p class="text-xs text-gray-500 mt-2">*æ­¤æ’è¡Œæ¦œç´€éŒ„æ–¼æœ¬è£ç½®çš„ç€è¦½å™¨ LocalStorageã€‚</p>
      </div>
    </div>
  </div>

  <script>
    // ====== å¸¸é‡ / åˆå§‹è³‡æ–™ ======
    const TOTAL = 10;
    const PASSWORD = "888";
    let currentStudent = null;
    let teacherMode = false;

    const LOCAL_GLOSSARY = {
      'ç§»ä½æ­¥æ³•ç·´ç¿’': 'è»Ÿå¼ç¶²çƒçš„æ­¥æ³•ç·´ç¿’å¼·èª¿å¿«é€Ÿç§»ä½èˆ‡æ“Šçƒä½ç½®èª¿æ•´ã€‚é‡é»æ˜¯ä¿æŒé‡å¿ƒåœ¨å‰è…³æŒï¼Œç§»å‹•å¾Œåˆ©ç”¨å°ç¢æ­¥èª¿æ•´åˆ°ä½ï¼Œä¸¦åŠæ™‚å›åˆ°ä¸­ç«‹ä½ç½®æº–å‚™ä¸‹ä¸€çƒã€‚',
      'æ­£æ‹åº•ç·šæ“Šçƒéç¶²': 'æ­£æ‹åº•ç·šæ“Šçƒæ˜¯æœ€åŸºæœ¬çš„æ“Šçƒå‹•ä½œã€‚æ¡æ‹å¤§æ‹‡æŒ‡æœä¸Šæ¯”è®šï¼Œè¦å´èº«å¼•æ‹ï¼Œç§»å‹•åˆ°ä½ï¼Œå‘å‰èª‡æ­¥è¸©è…³ï¼Œæ“Šçƒé»åœ¨èº«é«”æ–œå‰æ–¹è…°éƒ¨é«˜åº¦çš„ä½ç½®ï¼Œæ“Šçƒæ™‚æ‹é¢èˆ‡åœ°é¢å¹³è¡Œï¼Œè®“çƒç©©å®šè¶Šéçƒç¶²ä¸¦è½åœ¨å°æ–¹åº•ç·šå€åŸŸã€‚',
      'åæ‹åº•ç·šæ“Šçƒéç¶²': 'åæ‹æ“Šçƒæ¡æ‹å¤§æ‹‡æŒ‡æœä¸‹æ¯”éœï¼Œéœ€è¦ææ—©æº–å‚™ï¼Œéæ…£ç”¨æ‰‹å”åŠ©æ§åˆ¶æ‹é¢ï¼Œèº«é«”è½‰å´å¼•æ‹ç§»å‹•åˆ°ä½ï¼Œæ“Šçƒé»åœ¨èº«é«”æ–œå‰æ–¹è…°éƒ¨é«˜åº¦ä½ç½®ï¼Œæ“Šçƒæ™‚éæ…£ç”¨æ‰‹å¯å”åŠ©ç¶²å‰é€å‡ºåŠ›é‡ï¼ŒæŒæ‹æ‰‹å°‡åŠ›é‡æŒçºŒå¾€å‰å»¶ä¼¸é€å‡ºï¼Œé ˆå®Œæ•´æ®æ‹èˆ‡æ”¶æ‹å‹•ä½œã€‚æ³¨æ„æ‰‹è‡‚æ”¾é¬†ä¸¦é…åˆè…°éƒ¨è½‰å‹•ï¼Œè®“çƒé †åˆ©éç¶²ã€‚',
      'æ­£åæ‹ä¾†å›å°æ‰“': 'æ­£åæ‹äº¤æ›¿å°æ‰“æœ‰åŠ©æ–¼æå‡æ§çƒèƒ½åŠ›èˆ‡å”èª¿æ€§ã€‚é‡é»æ˜¯ä¿æŒç©©å®šç¯€å¥ï¼Œä¸æ€¥æ–¼å¾—åˆ†ï¼Œå°ˆæ³¨æ–¼æ­¥ä¼ç§»å‹•èˆ‡æ‹é¢è§’åº¦æ§åˆ¶ã€‚',
      'ä¸Šæ‰‹ç™¼çƒ': 'ä¸Šæ‰‹ç™¼çƒå‹•ä½œéœ€æ‹‹çƒé©ä¸­ã€å¼•æ‹å®Œæ•´ï¼Œæ“Šçƒé»åœ¨é ­é ‚ç¨å‰æ–¹ã€‚æ³¨æ„èº«é«”é‡å¿ƒè½‰ç§»èˆ‡æ‰‹è‡‚æ®å‹•çš„é€£è²«æ€§ï¼Œç¢ºä¿çƒè½å…¥å°è§’ç™¼çƒå€ã€‚',
      'å‰æ’æˆªæ“Šç·´ç¿’': 'æˆªæ“Šæ˜¯ç¶²å‰å¿«é€Ÿåæ‡‰çš„æŠ€è¡“ã€‚æ‹é¢æ‡‰ä¿æŒç©©å®šï¼Œæ‰‹è…•æ”¾é¬†ã€å‰è‡‚æ¨é€ï¼Œåˆ©ç”¨ä¾†çƒåŠ›é‡å¿«é€Ÿå›æ“Šï¼Œä¸éœ€å¤§å¹…åº¦æ®æ‹ã€‚',
      'é«˜å£“æ®ºçƒç·´ç¿’': 'é«˜å£“æ®ºçƒé€šå¸¸åœ¨å°æ‰‹å›å‡ºé«˜çƒæ™‚ä½¿ç”¨ã€‚é‡é»æ˜¯æŠ¬è‚˜å¼•æ‹ï¼Œæ“Šçƒé»åœ¨é ­é ‚æœ€é«˜é»ç¨å‰æ–¹ï¼Œå‘ä¸‹æ®æ‹ä¸¦æ§åˆ¶è½é»ï¼Œä»¥é€Ÿåº¦èˆ‡è§’åº¦å£“åˆ¶å°æ‰‹ã€‚',
      'ä½æ‰‹åˆ‡ç™¼çƒç·´ç¿’': 'ä½æ‰‹åˆ‡ç™¼çƒæ˜¯è»Ÿå¼ç¶²çƒç‰¹æœ‰çš„ç™¼çƒæ–¹å¼ã€‚æ“Šçƒæ™‚æ‹é¢ç•¥å¾®åˆ‡å‰Šï¼Œè®“çƒå¸¶æœ‰æ—‹è½‰ä¸¦é™ä½å½ˆè·³ã€‚é‡é»æ˜¯æ”¾é¬†æ‰‹è…•ã€æ§åˆ¶æ‹é¢è§’åº¦ï¼Œçƒéœ€è½åœ¨å°è§’ç™¼çƒå€ï¼Œä¸¦ä½¿çƒé«”æ–¼è½åœ°å¾Œç”¢ç”Ÿå´å‘æ—‹è½‰ç§»å‹•ï¼Œä½¿æ¥ç™¼çƒè€…ä¸æ˜“ç›´æ¥é€²è¡Œæ”»æ“Šã€‚',
      'è§€çœ‹ VR å­¸ç¿’å½±ç‰‡ï¼ˆä½æ‰‹åˆ‡ç™¼çƒï¼‰': 'é€é VR æ•™å­¸å¯ä»¥å¤šè§’åº¦è§€å¯Ÿä½æ‰‹åˆ‡ç™¼çƒçš„æ¨™æº–å‹•ä½œã€‚å»ºè­°å­¸ç”Ÿå°ˆæ³¨æ–¼çƒæ‹è§¸çƒç¬é–“çš„è§’åº¦èˆ‡èº«é«”é‡å¿ƒè½‰ç§»ï¼Œä¸¦åè¦†è§€çœ‹åŠ æ·±å°è±¡ã€‚',
      'ä½æ‰‹åˆ‡ç™¼çƒè€ƒè©¦': 'æ­¤é—œå¡æ˜¯æª¢æ¸¬å­¸ç”Ÿå°ä½æ‰‹åˆ‡ç™¼çƒçš„æŒæ¡ç¨‹åº¦ã€‚è€ƒè©¦æ™‚éœ€ä¿æŒå§¿å‹¢ç©©å®šï¼Œé€£çºŒå®ŒæˆæŒ‡å®šæ¬¡æ•¸çš„æ­£ç¢ºç™¼çƒï¼Œä¸¦ç¢ºä¿çƒè½åœ¨è¦å®šç™¼çƒå€åŸŸã€‚'
    };

    // é—œå¡å…§å®¹ + YouTube å½±ç‰‡
    const CHALLENGES = [
      {title:'ç§»ä½æ­¥æ³•ç·´ç¿’', goal:'ç†Ÿæ‚‰å ´ä¸Šå„æ–¹å‘çš„ç§»å‹•èˆ‡æ“Šçƒä½ç½®èª¿æ•´ã€‚', method:'ä¾åºå‘å››å€‹è§’è½ç§»å‹•ä¸¦æ¨¡æ“¬æ“Šçƒï¼Œåœ¨ 60 ç§’å…§å®Œæˆä¸€å¾ªç’°å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/4oTg4yA6aBo'},
      {title:'æ­£æ‹åº•ç·šæ“Šçƒéç¶²', goal:'èƒ½ä»¥æ­£æ‹åº•ç·šæ“Šçƒæ–¹å¼ï¼Œå°‡çƒç©©å®šæ‰“éç¶²ã€‚', method:'èˆ‡æ­æª”å¾åº•ç·šé–‹å§‹ï¼ŒæˆåŠŸ 5 æ¬¡å°‡çƒæ‰“éç¶²å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/pZ1m2hqu9Nw'},
      {title:'åæ‹åº•ç·šæ“Šçƒéç¶²', goal:'æŒæ¡åæ‹æ“ŠçƒæŠ€å·§èˆ‡çƒæ‹è§’åº¦æ§åˆ¶ã€‚', method:'èˆ‡æ­æª”åœ¨åº•ç·šç·´ç¿’åæ‹æ“Šçƒï¼ŒæˆåŠŸ 10 æ¬¡éç¶²å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/l4ft0Qj_MiU'},
      {title:'æ­£åæ‹ä¾†å›å°æ‰“', goal:'åŸ¹é¤Šç©©å®šçš„å›æ“Šèˆ‡å”èª¿æ€§ã€‚', method:'èˆ‡æ­æª”é€²è¡Œä¾†å›å°æ‰“ï¼Œé€£çºŒ 10 æ¬¡ä¸è½åœ°å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/nnPZxvNBgKY'},
      {title:'ä¸Šæ‰‹ç™¼çƒ', goal:'å­¸æœƒç”¨ä¸Šæ‰‹æ–¹å¼ç™¼çƒï¼Œçƒéœ€è½å…¥å°è§’ç™¼çƒæœ‰æ•ˆå€ã€‚', method:'èˆ‡æ­æª”è¼ªæµç™¼çƒï¼ŒæˆåŠŸ 5 æ¬¡å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/ZMts-Ggo6tI'},
      {title:'å‰æ’æˆªæ“Šç·´ç¿’', goal:'æŒæ¡åœ¨ç¶²å‰æ””æˆªä¾†çƒçš„æŠ€å·§ã€‚', method:'æ­æª”å¾åº•ç·šæ“Šçƒï¼Œç«™åœ¨ç¶²å‰ç·´ç¿’æˆªæ“Šï¼ŒæˆåŠŸ 10 æ¬¡å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/ESVhv1_gU7M'},
      {title:'é«˜å£“æ®ºçƒç·´ç¿’', goal:'å­¸ç¿’é«˜é»æ“Šçƒä¸¦å‘ä¸‹å£“çƒçš„æŠ€å·§ã€‚', method:'æ­æª”æ‹‹çƒè‡³é ­é ‚ä¸Šæ–¹ï¼Œè·³èµ·æˆ–æŠ¬é«˜æ“Šçƒï¼Œ æˆåŠŸ 5 æ¬¡å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/ADZn1N0a06E'},
      {title:'ä½æ‰‹åˆ‡ç™¼çƒç·´ç¿’', goal:'ç†Ÿæ‚‰è»Ÿå¼ç¶²çƒçš„åŸºæœ¬ä¸‹æ‰‹åˆ‡ç™¼çƒæ–¹å¼ã€‚', method:'ç”¨ä¸‹æ‰‹åˆ‡çƒæ–¹å¼ç™¼çƒï¼Œé€£çºŒ 5 æ¬¡éç¶²ä¸”è½å…¥å°è§’ç™¼çƒæœ‰æ•ˆå€å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/CqgwF3iewmQ'},
      {title:'è§€çœ‹ VR å­¸ç¿’å½±ç‰‡ï¼ˆä½æ‰‹åˆ‡ç™¼çƒï¼‰', goal:'é€é VR æŠ€è¡“è§€å¯Ÿèˆ‡å­¸ç¿’æ­£ç¢ºçš„ä½æ‰‹åˆ‡ç™¼çƒå‹•ä½œã€‚', method:'å®Œæ•´è§€çœ‹ 4 å‘¨ (2æ¬¡/å‘¨) æŒ‡å®š VR æ•™å­¸å½±ç‰‡ï¼Œç†è§£ä¸¦æ¨¡ä»¿å‹•ä½œå³å¯éé—œã€‚', video:'https://www.youtube.com/embed/CqgwF3iewmQ'},
      {title:'ä½æ‰‹åˆ‡ç™¼çƒè€ƒè©¦', goal:'æª¢é©—å­¸ç”Ÿå°ä½æ‰‹åˆ‡ç™¼çƒçš„æŒæ¡ç¨‹åº¦ã€‚', method:'å®Œæˆæ•™å¸«æŒ‡å®šçš„ 12 åˆ†ä½æ‰‹åˆ‡ç™¼çƒ (å³é‚Šå¤–è§’3åˆ†ã€å³é‚Šå…§è§’3åˆ†ã€å·¦é‚Šå…§è§’3åˆ†ã€å·¦é‚Šå¤–è§’3åˆ†) å³å¯éé—œã€‚', video:'https://www.youtube.com/embed/CqgwF3iewmQ'},
    ];

    // ====== å·¥å…·å‡½å¼ ======
    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    const nowISO = () => new Date().toISOString();

    function keyFor(student) { return `softtennis_${student}`; }
    function getProgress(student) { return JSON.parse(localStorage.getItem(keyFor(student)) || '{}'); }
    function setProgress(student, obj) { localStorage.setItem(keyFor(student), JSON.stringify(obj)); }

    function beep() {
      // ä½¿ç”¨ WebAudio ç°¡æ˜“éŸ³æ•ˆ
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='triangle'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
      o.start(); o.stop(ctx.currentTime + 0.36);
    }

    // ====== ç™»å…¥ / æ¨¡å¼ ======
    function login() {
      const id = qs('#studentId').value.trim();
      const name = qs('#studentName').value.trim();
      if(!id || !name) return alert('è«‹è¼¸å…¥å­¸è™Ÿèˆ‡å§“å');
      currentStudent = `${id}_${name}`;
      // åˆå§‹åŒ–æ™‚é–“æˆ³
      const p = getProgress(currentStudent);
      if(!p._meta) p._meta = { createdAt: nowISO(), lastUpdatedAt: nowISO(), wrongPassword: {}, firstFinishAt: null };
      setProgress(currentStudent, p);

      qs('#helloText').textContent = `Hiï¼Œ${name}`;
      qs('#loginSection').classList.add('hidden');
      qs('#app').classList.remove('hidden');
      renderCards(); loadStamps(); updateOverall();
      // æ•™å¸«æ¨¡å¼é¡¯ç¤ºå¾½ç« æ–¼ä¸»ç•«é¢
      qs('#modePill2').classList.toggle('hidden', !teacherMode);
    }

    function logout() {
      currentStudent = null;
      qs('#app').classList.add('hidden');
      qs('#loginSection').classList.remove('hidden');
      qs('#studentId').value=''; qs('#studentName').value='';
    }

    function toggleTeacherMode() {
      teacherMode = !teacherMode;
      qs('#modePill').classList.toggle('hidden', !teacherMode);
      if(currentStudent) qs('#modePill2').classList.toggle('hidden', !teacherMode);
    }

    // ====== é—œå¡æ¸²æŸ“ ======
    function cardTemplate(idx, c) {
      return `
      <article class="card p-5 stamp-wrap relative">
        <svg id="stamp${idx}" class="stamp-svg" viewBox="0 0 120 120" aria-hidden="true">
          <defs>
            <filter id="rough"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="1" result="noise"/>
              <feDisplacementMap in="SourceGraphic" in2="noise" scale="1"/>
            </filter>
          </defs>
          <circle cx="60" cy="60" r="46" fill="none" stroke="#ef4444" stroke-width="6"></circle>
          <text x="60" y="66" text-anchor="middle" font-size="26" font-weight="800" fill="#ef4444" style="letter-spacing:2px; filter:url(#rough)">å®Œæˆ</text>
        </svg>
        <h3 class="text-xl font-bold text-[var(--headline)] mb-2">é—œå¡${idx}ï¼š${c.title}</h3>
        <p class="text-sm text-gray-700"><b>ç›®æ¨™ï¼š</b>${c.goal}</p>
        <p class="text-sm text-gray-700 mt-1"><b>åŸ·è¡Œæ–¹å¼ï¼š</b>${c.method}</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="btn btn-ghost" onclick="openGlossary('${c.title}')">âœ¨ èªªæ˜è¡“èª</button>
          <button class="btn btn-purple" onclick="openVideo(${idx}, '${c.title}', '${c.video}')">ğŸ“˜ å­¸ç¿’è³‡æº</button>
          <button class="btn btn-green" onclick="verify(${idx}, '${c.title}')">âœ… é—–é—œæˆåŠŸ</button>
        </div>
      </article>`;
    }

    function renderCards() {
      const wrap = qs('#cards');
      wrap.innerHTML = CHALLENGES.map((c, i) => cardTemplate(i+1, c)).join('');
    }

    // ====== å°ç« èˆ‡é©—è­‰ ======
    function loadStamps() {
      const p = getProgress(currentStudent);
      for(let i=1; i<=TOTAL; i++) {
        const done = p['challenge'+i] === true;
        if(done) qs('#stamp'+i)?.classList.add('stamp-bounce');
      }
    }

    function markDone(i) {
      const el = qs('#stamp'+i);
      if(!el) return;
      el.classList.remove('stamp-bounce'); // é‡æ–°æ’­æ”¾å‹•ç•«
      // è§¸ç™¼ reflow
      void el.offsetWidth;
      el.classList.add('stamp-bounce');
    }

    function verify(i, title) {
      const input = prompt(`è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªã€Œé—œå¡${i}ï¼š${title}ã€éé—œï¼š`);
      const p = getProgress(currentStudent);
      if(!p._meta) p._meta = { createdAt: nowISO(), lastUpdatedAt: nowISO(), wrongPassword:{}, firstFinishAt:null };

      if(input === null) return; // å–æ¶ˆ
      if(input === PASSWORD) {
        // æˆåŠŸ
        p['challenge'+i] = true;
        p._meta.lastUpdatedAt = nowISO();
        // è¨˜éŒ„è‹¥å…¨éƒ¨å®Œæˆå‰‡æ™‚é–“æˆ³
        const count = countCompleted(p);
        if(count === TOTAL && !p._meta.firstFinishAt) p._meta.firstFinishAt = nowISO();
        setProgress(currentStudent, p);
        markDone(i); beep(); updateOverall();
        alert(`ğŸ‰ æ­å–œï¼é—œå¡${i} å·²é€šéï¼`);
      } else {
        // éŒ¯èª¤æ¬¡æ•¸
        const wp = p._meta.wrongPassword || {}; wp[i] = (wp[i]||0) + 1; p._meta.wrongPassword = wp;
        p._meta.lastUpdatedAt = nowISO();
        setProgress(currentStudent, p);
        if(wp[i] >= 3) {
          alert('â— å·²éŒ¯èª¤è¼¸å…¥ 3 æ¬¡ï¼Œè«‹ç¢ºèªæ˜¯å¦å®Œæˆä»»å‹™å†å˜—è©¦ã€‚');
        } else {
          alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
        }
      }
    }

    // ====== é€²åº¦ç¸½è¦½ / çå‹µ ======
    let overallChart;

    function countCompleted(p) {
      return Object.keys(p).filter(k => k.startsWith('challenge') && p[k] === true).length;
    }

    function updateOverall() {
      const p = getProgress(currentStudent);
      const done = countCompleted(p);
      const percent = Math.round(done / TOTAL * 100);
      qs('#overallText').textContent = `å·²å®Œæˆ ${done}/${TOTAL} (${percent}%)`;
      // å¾½ç« 
      qs('#badge5').classList.toggle('hidden', done < 5);
      qs('#badge8').classList.toggle('hidden', done < 8);
      qs('#badge10').classList.toggle('hidden', done < 10);

      // åœ“å½¢åœ–
      const ctx = qs('#overallChart').getContext('2d');
      if(!overallChart) {
        overallChart = new Chart(ctx, {
          type: 'doughnut',
          data: { datasets: [{ data: [done, TOTAL-done], borderWidth: 4 }]},
          options: {
            cutout: '75%',
            plugins: {
              legend: { display:false },
              tooltip: { enabled:false }
            }
          }
        });
      } else {
        overallChart.data.datasets[0].data = [done, TOTAL-done];
        overallChart.update();
      }

      // 100% é¡¯ç¤ºçç›ƒå‹•ç•«
      if(done === TOTAL) showTrophy();
      else hideTrophy();
    }

    function showTrophy() { qs('#trophy').classList.add('show'); beep(); }
    function hideTrophy() { qs('#trophy').classList.remove('show'); }

    // ====== èªªæ˜è¡“èª Modal ======
    function openGlossary(title) {
      qs('#glossaryTitle').textContent = `èªªæ˜è¡“èªï¼š${title}`;
      qs('#glossaryBody').textContent = LOCAL_GLOSSARY[title] || 'ï¼ˆå°šç„¡èªªæ˜ï¼‰';
      qs('#glossaryModal').classList.add('show');
    }
    function closeGlossary(){ qs('#glossaryModal').classList.remove('show'); }

    // ====== å½±ç‰‡ Modal ======
    function openVideo(i, title, url) {
      qs('#videoTitle').textContent = `å­¸ç¿’è³‡æºï¼šé—œå¡${i}ã€Œ${title}ã€`;
      const src = url.includes('embed') ? url : url.replace('watch?v=', 'embed/');
      qs('#videoFrame').src = src + '?autoplay=1&rel=0';
      qs('#videoModal').classList.add('show');
    }
    function closeVideo(){ qs('#videoFrame').src=''; qs('#videoModal').classList.remove('show'); }

    // ====== æ’è¡Œæ¦œ (æœ¬æ©Ÿ) ======
    function openLeaderboard() {
      const body = qs('#leaderboardBody'); body.innerHTML = '';
      for(let i=0; i<localStorage.length; i++) {
        const key = localStorage.key(i);
        if(!key.startsWith('softtennis_')) continue;
        const who = key.replace('softtennis_', '');
        const [sid, name] = who.split('_');
        const p = JSON.parse(localStorage.getItem(key) || '{}');
        const done = countCompleted(p);
        const percent = Math.round(done / TOTAL * 100);
        const meta = p._meta || {};
        const last = meta.lastUpdatedAt ? new Date(meta.lastUpdatedAt).toLocaleString() : '-';
        let totalTime = '-';
        if(meta.firstFinishAt && meta.createdAt) {
          const t = (new Date(meta.firstFinishAt) - new Date(meta.createdAt))/1000;
          totalTime = `${Math.floor(t/60)}åˆ†${Math.floor(t%60)}ç§’`;
        }
        body.insertAdjacentHTML('beforeend',
          `<tr><td>${sid}</td><td>${name}</td><td>${done}/${TOTAL}</td><td>${percent}%</td><td>${last}</td><td>${totalTime}</td></tr>`
        );
      }
      qs('#leaderboardModal').classList.add('show');
    }
    function closeLeaderboard(){ qs('#leaderboardModal').classList.remove('show'); }

    // ====== å•Ÿå‹• ======
    document.addEventListener('DOMContentLoaded', () => {
      // nothing yet
    });
  </script>
</body>
</html>
