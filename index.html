<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>水上自救闖關任務</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --ink: #263159;
      --primary: #FF8F52;
      --headline: #495579;
      --paper: #FFFDF7;
      --success: #16a34a;
      --danger: #ef4444;
      --accent: #8b5cf6;
    }
    body { background: var(--paper); color: var(--ink); }
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.08); }

    /* 完成印章 */
    .stamp-wrap { position: relative; }
    .stamp-svg {
      position:absolute; top:-10px; left:50%; transform:translateX(-50%) rotate(-8deg) scale(0.2);
      width:120px; height:120px; opacity:0; pointer-events:none;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
    }
    .stamp-bounce { animation: stampIn .7s ease-out forwards; }
    @keyframes stampIn {
      0% { transform:translateX(-50%) rotate(-8deg) scale(0.2); opacity:0; }
      60% { transform:translateX(-50%) rotate(-6deg) scale(1.15); opacity:1; }
      100% { transform:translateX(-50%) rotate(-8deg) scale(1); opacity:1; }
    }

    /* Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.show { display:flex; }
    .modal-card { width: min(460px, 92vw); background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #eee; }
    .close-x { font-size:20px; font-weight:700; cursor:pointer; }
    .modal-body { padding:1rem; }

    /* 按鈕/徽章 */
    .btn { padding:.6rem 1rem; border-radius:.75rem; font-weight:700; }
    .btn-green { background:var(--success); color:#fff; }
    .btn-purple { background:var(--accent); color:#fff; }
    .btn-red { background:var(--danger); color:#fff; }
    .btn-ghost { background:#f3f4f6; }
    .badge { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; border-radius:999px; font-weight:700; }
    .badge-silver { background:#eef2ff; border:2px solid #c7d2fe; }
    .badge-gold { background:#fff7e6; border:2px solid #facc15; }
    .badge-trophy { background:#fff1f2; border:2px solid #fb7185; }

    /* 獎盃動畫 */
    .trophy-wrap { position:fixed; left:50%; top:-40vh; transform:translateX(-50%); z-index:60; pointer-events:none; display:none; }
    .trophy-wrap.show { display:block; animation: dropIn 1s ease-out forwards, glow 2s ease-in-out 1s infinite alternate; }
    @keyframes dropIn { 0% { top:-40vh; } 80% { top:15vh; } 100% { top:18vh; } }
    @keyframes glow { from { filter: drop-shadow(0 0 0 rgba(250, 204, 21, .8)); } to { filter: drop-shadow(0 0 18px rgba(250, 204, 21, 1)); } }
  </style>
</head>
<body class="min-h-screen">
  <!-- 獎盃 -->
  <div id="trophy" class="trophy-wrap" aria-hidden="true">
    <svg width="220" height="220" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#facc15"/><stop offset="100%" stop-color="#eab308"/></linearGradient></defs>
      <g fill="url(#g)" stroke="#92400e" stroke-width="1">
        <path d="M12 8h40v6a14 14 0 0 1-14 14H26A14 14 0 0 1 12 14z"/>
        <path d="M16 8v-4h32v4z"/>
        <rect x="28" y="28" width="8" height="8" rx="1"/>
        <rect x="24" y="36" width="16" height="6" rx="1"/>
        <rect x="20" y="42" width="24" height="6" rx="1"/>
        <rect x="16" y="48" width="32" height="6" rx="1"/>
      </g>
      <circle cx="32" cy="19" r="7" fill="#fde68a" opacity=".7"/>
    </svg>
  </div>

  <!-- 頁首 -->
  <header class="text-center px-4 py-6">
    <h1 class="text-3xl md:text-4xl font-extrabold text-[var(--headline)]">水上自救闖關任務</h1>
  </header>

  <!-- 登入區 -->
  <section id="loginSection" class="max-w-xl card mx-auto p-6 my-6">
    <h2 class="text-xl font-bold">學生登入</h2>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <input id="studentId" class="border rounded-lg p-3" placeholder="學號" />
      <input id="studentName" class="border rounded-lg p-3" placeholder="姓名" />
    </div>
    <div class="mt-4 flex gap-3">
      <button class="btn btn-green" onclick="login()">登入</button>
    </div>
  </section>

  <!-- 主內容 -->
  <main id="app" class="container mx-auto px-4 pb-20 hidden">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        <span id="helloText" class="font-bold"></span>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-red" onclick="logout()">登出</button>
      </div>
    </div>

    <!-- 進度總覽 -->
    <section class="card p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
        <div class="justify-self-center">
          <canvas id="overallChart" width="220" height="220"></canvas>
        </div>
        <div class="md:col-span-2">
          <h3 class="text-xl font-bold mb-2">個人進度</h3>
          <p id="overallText" class="text-sm text-gray-700 mb-3">已完成 0/4 (0%)</p>
          <div class="flex flex-wrap gap-2 items-center">
            <span id="badge3" class="badge badge-silver hidden">🥈 銀牌（3/4）</span>
            <span id="badge4" class="badge badge-gold hidden">🥇 金牌（全部完成）</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 關卡卡片 -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
      <div id="cards" class="contents"></div>
    </section>
  </main>

  <!-- Glossary Modal -->
  <div id="glossaryModal" class="modal" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="glossaryTitle">說明術語</h3>
        <span class="close-x" onclick="closeGlossary()">✖</span>
      </div>
      <div class="modal-body p-4">
        <p id="glossaryBody" class="text-gray-800 leading-7"></p>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="videoTitle">學習資源</h3>
        <span class="close-x" onclick="closeVideo()">✖</span>
      </div>
      <div class="modal-body">
        <div class="aspect-video w-full">
          <iframe id="videoFrame" class="w-full h-[60vh]" src="" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="font-bold" id="passwordTitle">輸入密碼</h3>
        <span class="close-x" onclick="closePassword()">✖</span>
      </div>
      <div class="modal-body">
        <p class="mb-3 text-gray-700" id="passwordDesc"></p>
        <input id="passwordInput" type="password" placeholder="請輸入密碼"
               class="border rounded-lg p-2 w-full mb-3" />
        <button class="btn btn-green w-full" id="passwordBtn">確認</button>
      </div>
    </div>
  </div>

  <script>
    const TOTAL = 4;
    const PASSWORD = "888";
    let currentStudent = null;
    let currentChallenge = null;

    const GLOSSARY = {
      '水母漂': '雙手雙腳自然張開，臉朝下放鬆，雙手雙腳自然放鬆漂浮於水面。',
      '仰漂': '臉朝上，耳朵浸入水中，手腳張開放鬆，保持呼吸平穩漂浮。',
      '踩水': '雙腿交替打水或畫圈，保持頭部在水面上。',
      '拋繩': '使用拋繩拋向指定位置。'
    };

    const CHALLENGES = [
      {title:'水母漂', goal:'學會臉朝下放鬆漂浮。', method:'在水中雙手雙腳自然放鬆，維持至少 1 分鐘。', video:''},
      {title:'仰漂', goal:'學會臉朝上漂浮。', method:'耳朵入水，雙手雙腳張開，維持至少 1 分鐘。', video:''},
      {title:'踩水', goal:'學會保持頭部在水面上。', method:'連續踩水 1 分鐘不沉下去。', video:''},
      {title:'拋繩', goal:'學會正確拋繩救援。', method:'將繩子準確拋向指定目標。', video:''}
    ];

    const qs = (sel) => document.querySelector(sel);
    const nowISO = () => new Date().toISOString();
    function keyFor(student) { return `water_${student}`; }
    function getProgress(student) { return JSON.parse(localStorage.getItem(keyFor(student)) || '{}'); }
    function setProgress(student, obj) { localStorage.setItem(keyFor(student), JSON.stringify(obj)); }
    function beep() { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='triangle'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime + 0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.32); o.start(); o.stop(ctx.currentTime + 0.33); }

    function login() {
      const id = qs('#studentId').value.trim();
      const name = qs('#studentName').value.trim();
      if(!id || !name) return alert('請輸入學號與姓名');
      currentStudent = `${id}_${name}`;
      const p = getProgress(currentStudent);
      if(!p._meta) p._meta = { createdAt: nowISO(), lastUpdatedAt: nowISO(), wrongPassword: {}, firstFinishAt: null };
      setProgress(currentStudent, p);
      qs('#helloText').textContent = `Hi，${name}`;
      qs('#loginSection').classList.add('hidden');
      qs('#app').classList.remove('hidden');
      renderCards(); loadStamps(); updateOverall();
    }
    function logout(){ currentStudent=null; qs('#app').classList.add('hidden'); qs('#loginSection').classList.remove('hidden'); }

    function cardTemplate(idx, c){
      return `
      <article class="card p-5 stamp-wrap relative">
        <svg id="stamp${idx}" class="stamp-svg" viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="46" fill="none" stroke="#ef4444" stroke-width="6"></circle>
          <text x="60" y="66" text-anchor="middle" font-size="22" font-weight="800" fill="#ef4444">完成</text>
        </svg>
        <h3 class="text-xl font-bold mb-2">關卡${idx}：${c.title}</h3>
        <p class="text-sm text-gray-700"><b>目標：</b>${c.goal}</p>
        <p class="text-sm text-gray-700 mt-1"><b>執行方式：</b>${c.method}</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="btn btn-ghost" onclick="openGlossary('${c.title}')">✨ 說明術語</button>
          <button class="btn btn-purple" onclick="openVideo(${idx}, '${c.title}', '${c.video}')">📘 學習資源</button>
          <button class="btn btn-green" onclick="verify(${idx}, '${c.title}')">✅ 闖關成功</button>
        </div>
      </article>`;
    }
    function renderCards(){ qs('#cards').innerHTML = CHALLENGES.map((c,i)=>cardTemplate(i+1,c)).join(''); }

    function loadStamps(){ const p=getProgress(currentStudent); for(let i=1;i<=TOTAL;i++){ if(p['challenge'+i]===true) qs('#stamp'+i)?.classList.add('stamp-bounce'); } }
    function markDone(i){ const el=qs('#stamp'+i); if(!el) return; el.classList.remove('stamp-bounce'); void el.offsetWidth; el.classList.add('stamp-bounce'); }

    function verify(i, title){
      currentChallenge = { i, title };
      qs('#passwordTitle').textContent = `驗證：關卡${i} ${title}`;
      qs('#passwordDesc').textContent = `請輸入密碼以確認「關卡${i}：${title}」過關：`;
      qs('#passwordInput').value = '';
      qs('#passwordModal').classList.add('show');
    }
    function closePassword(){ qs('#passwordModal').classList.remove('show'); }

    document.getElementById('passwordBtn').addEventListener('click', () => {
      const input = document.getElementById('passwordInput').value;
      const { i, title } = currentChallenge;
      const p = getProgress(currentStudent);
      if(!p._meta) p._meta={createdAt:nowISO(),lastUpdatedAt:nowISO(),wrongPassword:{},firstFinishAt:null};

      if(input===PASSWORD){
        p['challenge'+i]=true;
        p._meta.lastUpdatedAt=nowISO();
        const count=countCompleted(p);
        if(count===TOTAL && !p._meta.firstFinishAt) p._meta.firstFinishAt=nowISO();
        setProgress(currentStudent,p);
        markDone(i); beep(); updateOverall();
        alert(`🎉 恭喜！關卡${i} 已通過！`);
        closePassword();
      } else {
        const wp=p._meta.wrongPassword||{}; wp[i]=(wp[i]||0)+1;
        p._meta.wrongPassword=wp; p._meta.lastUpdatedAt=nowISO(); setProgress(currentStudent,p);
        alert('❌ 密碼錯誤，請再試一次。');
      }
    });

    let overallChart;
    function countCompleted(p){ return Object.keys(p).filter(k=>k.startsWith('challenge') && p[k]===true).length; }
    function updateOverall(){
      const p=getProgress(currentStudent); const done=countCompleted(p); const percent=Math.round(done/TOTAL*100);
      qs('#overallText').textContent = `已完成 ${done}/${TOTAL} (${percent}%)`;
      qs('#badge3').classList.toggle('hidden', done<3);
      qs('#badge4').classList.toggle('hidden', done<TOTAL);
      const ctx=document.getElementById('overallChart').getContext('2d');
      if(!overallChart){ overallChart=new Chart(ctx,{ type:'doughnut', data:{ datasets:[{ data:[done, TOTAL-done], borderWidth:4 }]}, options:{ cutout:'75%', plugins:{ legend:{display:false}, tooltip:{enabled:false} } } }); }
      else { overallChart.data.datasets[0].data=[done, TOTAL-done]; overallChart.update(); }
      if(done===TOTAL) showTrophy(); else hideTrophy();
    }
    function showTrophy(){ document.getElementById('trophy').classList.add('show'); beep(); }
    function hideTrophy(){ document.getElementById('trophy').classList.remove('show'); }

    function openGlossary(title){ qs('#glossaryTitle').textContent = `說明術語：${title}`; qs('#glossaryBody').textContent = GLOSSARY[title] || '（尚無說明）'; qs('#glossaryModal').classList.add('show'); }
    function closeGlossary(){ qs('#glossaryModal').classList.remove('show'); }
    function openVideo(i,title,url){ qs('#videoTitle').textContent = `學習資源：關卡${i}「${title}」`; if(url){ const src = url.includes('embed')?url:url.replace('watch?v=','embed/'); qs('#videoFrame').src = src; } qs('#videoModal').classList.add('show'); }
    function closeVideo(){ qs('#videoFrame').src=''; qs('#videoModal').classList.remove('show'); }
  </script>
</body>
</html>
